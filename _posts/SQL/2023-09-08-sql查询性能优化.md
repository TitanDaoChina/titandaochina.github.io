# sql查询性能优化
## 1、获取sql查询计划
```shell
MySQL [dwd_test]> explain graph select t1.dynamic_day,per_customer_transaction , refund_orders , pay_order_rate from (  select substr( take_at,1,10) as dynamic_day,round(sum(if(is_effect=1,payment,0)) / count(distinct if(is_effect=1,ouid,null)),2) as per_customer_transaction , concat_ws('',round(count(distinct if(is_effect=1,ouid,null))/count(distinct ouid)*100,2),'%') as pay_order_rate from dwd.dwd_order_detail where merchant_num = 1011484 and take_at is not null  group by dynamic_day  ) t1  left join [shuffle] (  select substr( end_at,1,10) as dynamic_day,count(if(status=101,platform_order_id,null)) as refund_orders from dwd.dwd_order_detail where merchant_num = 1011484 and end_at is not null  group by dynamic_day  ) t2 on  t1.dynamic_day = t2.dynamic_day   order by dynamic_day desc  limit 10000
    -> ;
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Explain String                                                                                                                                                                                                      |
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                           ┌────────────────┐                                                                                                                                                                        |
|                           │[12: ResultSink]│                                                                                                                                                                        |
|                           │[Fragment: 5]   │                                                                                                                                                                        |
|                           │RESULT SINK     │                                                                                                                                                                        |
|                           └────────────────┘                                                                                                                                                                        |
|                                    │                                                                                                                                                                                |
|                                    │                                                                                                                                                                                |
|                        ┌──────────────────────┐                                                                                                                                                                     |
|                        │[12: MERGING-EXCHANGE]│                                                                                                                                                                     |
|                        │[Fragment: 5]         │                                                                                                                                                                     |
|                        └──────────────────────┘                                                                                                                                                                     |
|                                    │                                                                                                                                                                                |
|                                    │                                                                                                                                                                                |
|                         ┌────────────────────┐                                                                                                                                                                      |
|                         │[12: DataStreamSink]│                                                                                                                                                                      |
|                         │[Fragment: 4]       │                                                                                                                                                                      |
|                         │STREAM DATA SINK    │                                                                                                                                                                      |
|                         │  EXCHANGE ID: 12   │                                                                                                                                                                      |
|                         │  UNPARTITIONED     │                                                                                                                                                                      |
|                         └────────────────────┘                                                                                                                                                                      |
|                                    │                                                                                                                                                                                |
|                                    │                                                                                                                                                                                |
|                             ┌─────────────┐                                                                                                                                                                         |
|                             │[5: TOP-N]   │                                                                                                                                                                         |
|                             │[Fragment: 4]│                                                                                                                                                                         |
|                             └─────────────┘                                                                                                                                                                         |
|                                    │                                                                                                                                                                                |
|                                    │                                                                                                                                                                                |
|                ┌──────────────────────────────────────┐                                                                                                                                                             |
|                │[4: HASH JOIN]                        │                                                                                                                                                             |
|                │[Fragment: 4]                         │                                                                                                                                                             |
|                │join op: LEFT OUTER JOIN (PARTITIONED)│                                                                                                                                                             |
|                └──────────────────────────────────────┘                                                                                                                                                             |
|                  ┌─────────────────┴─────────────────┐                                                                                                                                                              |
|                  │                                   │                                                                                                                                                              |
|          ┌──────────────┐                    ┌──────────────┐                                                                                                                                                       |
|          │[10: EXCHANGE]│                    │[11: EXCHANGE]│                                                                                                                                                       |
|          │[Fragment: 4] │                    │[Fragment: 4] │                                                                                                                                                       |
|          └──────────────┘                    └──────────────┘                                                                                                                                                       |
|                  │                                   │                                                                                                                                                              |
|                  │                                   │                                                                                                                                                              |
|       ┌────────────────────┐              ┌────────────────────┐                                                                                                                                                    |
|       │[10: DataStreamSink]│              │[11: DataStreamSink]│                                                                                                                                                    |
|       │[Fragment: 1]       │              │[Fragment: 3]       │                                                                                                                                                    |
|       │STREAM DATA SINK    │              │STREAM DATA SINK    │                                                                                                                                                    |
|       │  EXCHANGE ID: 10   │              │  EXCHANGE ID: 11   │                                                                                                                                                    |
|       │  HASH_PARTITIONED  │              │  HASH_PARTITIONED  │                                                                                                                                                    |
|       └────────────────────┘              └────────────────────┘                                                                                                                                                    |
|                  │                                   │                                                                                                                                                              |
|                  │                                   │                                                                                                                                                              |
|  ┌───────────────────────────────┐   ┌───────────────────────────────┐                                                                                                                                              |
|  │[7: AGGREGATE (merge finalize)]│   │[9: AGGREGATE (merge finalize)]│                                                                                                                                              |
|  │[Fragment: 1]                  │   │[Fragment: 3]                  │                                                                                                                                              |
|  └───────────────────────────────┘   └───────────────────────────────┘                                                                                                                                              |
|                  │                                   │                                                                                                                                                              |
|                  │                                   │                                                                                                                                                              |
|           ┌─────────────┐                     ┌─────────────┐                                                                                                                                                       |
|           │[6: EXCHANGE]│                     │[8: EXCHANGE]│                                                                                                                                                       |
|           │[Fragment: 1]│                     │[Fragment: 3]│                                                                                                                                                       |
|           └─────────────┘                     └─────────────┘                                                                                                                                                       |
|                  │                                   │                                                                                                                                                              |
|                  │                                   │                                                                                                                                                              |
|        ┌───────────────────┐               ┌───────────────────┐                                                                                                                                                    |
|        │[6: DataStreamSink]│               │[8: DataStreamSink]│                                                                                                                                                    |
|        │[Fragment: 0]      │               │[Fragment: 2]      │                                                                                                                                                    |
|        │STREAM DATA SINK   │               │STREAM DATA SINK   │                                                                                                                                                    |
|        │  EXCHANGE ID: 06  │               │  EXCHANGE ID: 08  │                                                                                                                                                    |
|        │  HASH_PARTITIONED │               │  HASH_PARTITIONED │                                                                                                                                                    |
|        └───────────────────┘               └───────────────────┘                                                                                                                                                    |
|                  │                                   │                                                                                                                                                              |
|                  │                                   │                                                                                                                                                              |
| ┌─────────────────────────────────┐ ┌─────────────────────────────────┐                                                                                                                                             |
| │[1: AGGREGATE (update serialize)]│ │[3: AGGREGATE (update serialize)]│                                                                                                                                             |
| │[Fragment: 0]                    │ │[Fragment: 2]                    │                                                                                                                                             |
| │STREAMING                        │ │STREAMING                        │                                                                                                                                             |
| └─────────────────────────────────┘ └─────────────────────────────────┘                                                                                                                                             |
|                  │                                   │                                                                                                                                                              |
|                  │                                   │                                                                                                                                                              |
|      ┌───────────────────────┐           ┌───────────────────────┐                                                                                                                                                  |
|      │[0: OlapScanNode]      │           │[2: OlapScanNode]      │                                                                                                                                                  |
|      │[Fragment: 0]          │           │[Fragment: 2]          │                                                                                                                                                  |
|      │TABLE: dwd_order_detail│           │TABLE: dwd_order_detail│                                                                                                                                                  |
|      └───────────────────────┘           └───────────────────────┘                                                                                                                                                  |
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
83 rows in set (0.00 sec)
```
图形命令仅展示简化后的节点信息，如果需要查看更具体的节点信息，如节点上的过滤条件等，则需要通过第二个命令查看更详细的文字版信息：
```shell
MySQL [(none)]> explain select t1.dynamic_day,per_customer_transaction , refund_orders , pay_order_rate from (  select substr( take_at,1,10) as dynamic_day,round(sum(if(is_effect=1,payment,0)) / count(distinct if(is_effect=1,ouid,null)),2) as per_customer_transaction , concat_ws('',round(count(distinct if(is_effect=1,ouid,null))/count(distinct ouid)*100,2),'%') as pay_order_rate from dwd.dwd_order_detail where merchant_num = 1011484 and take_at is not null  group by dynamic_day  ) t1  left join [shuffle] (  select substr( end_at,1,10) as dynamic_day,count(if(status=101,platform_order_id,null)) as refund_orders from dwd.dwd_order_detail where merchant_num = 1011484 and end_at is not null  group by dynamic_day  ) t2 on  t1.dynamic_day = t2.dynamic_day   order by dynamic_day desc  limit 10000 ;
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Explain String                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| PLAN FRAGMENT 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|  OUTPUT EXPRS:<slot 24> `t1`.`dynamic_day` | <slot 26> `per_customer_transaction` | <slot 25> `refund_orders` | <slot 27> `pay_order_rate`                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|   PARTITION: UNPARTITIONED                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|   RESULT SINK                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|   12:MERGING-EXCHANGE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|      limit: 10000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| PLAN FRAGMENT 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|  OUTPUT EXPRS:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|   PARTITION: HASH_PARTITIONED: <slot 9> substr(`take_at`, 1, 10)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|   STREAM DATA SINK                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|     EXCHANGE ID: 12                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|     UNPARTITIONED                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|   5:TOP-N                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|   |  order by: <slot 24> `t1`.`dynamic_day` DESC                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|   |  offset: 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|   |  limit: 10000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|   4:HASH JOIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|   |  join op: LEFT OUTER JOIN (PARTITIONED)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|   |  hash predicates:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|   |  colocate: false, reason: Has join hint                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|   |  equal join conjunct: <slot 9> substr(`take_at`, 1, 10) = <slot 20> substr(`end_at`, 1, 10)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|   |  cardinality=-1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|   |----11:EXCHANGE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|   10:EXCHANGE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| PLAN FRAGMENT 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|  OUTPUT EXPRS:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|   PARTITION: HASH_PARTITIONED: <slot 20> substr(`end_at`, 1, 10)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|   STREAM DATA SINK                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|     EXCHANGE ID: 11                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|     HASH_PARTITIONED: <slot 20> substr(`end_at`, 1, 10)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|   9:AGGREGATE (merge finalize)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|   |  output: count(<slot 21> count(if(`status` = 101.0, `platform_order_id`, NULL)))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|   |  group by: <slot 20> substr(`end_at`, 1, 10)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|   |  cardinality=-1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|   8:EXCHANGE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| PLAN FRAGMENT 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|  OUTPUT EXPRS:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|   PARTITION: HASH_PARTITIONED: `default_cluster:dwd`.`dwd_order_detail`.`brand_code`, `default_cluster:dwd`.`dwd_order_detail`.`merchant_num`, `default_cluster:dwd`.`dwd_order_detail`.`ouid`                                                                                                                                                                                                                                                                                                                                                                                                                         |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|   STREAM DATA SINK                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|     EXCHANGE ID: 08                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|     HASH_PARTITIONED: <slot 20> substr(`end_at`, 1, 10)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|   3:AGGREGATE (update serialize)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|   |  STREAMING                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|   |  output: count(if(`status` = 101.0, `platform_order_id`, NULL))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|   |  group by: substr(`end_at`, 1, 10)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|   |  cardinality=-1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|   2:OlapScanNode                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|      TABLE: dwd_order_detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|      PREAGGREGATION: OFF. Reason: conjunct on `end_at` which is StorageEngine value column                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|      PREDICATES: `merchant_num` = 1011484, `end_at` IS NOT NULL, `default_cluster:dwd.dwd_order_detail`.`__DORIS_DELETE_SIGN__` = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|      partitions=148/151                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|      rollup: dwd_order_detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|      tabletRatio=2368/2368                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|      tabletList=8492494,8492498,8492502,8492506,8492510,8492514,8492518,8492522,8492526,8492530 ...                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|      cardinality=333775237                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|      avgRowSize=75.81013                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|      numNodes=10                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| PLAN FRAGMENT 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|  OUTPUT EXPRS:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|   PARTITION: HASH_PARTITIONED: <slot 5> substr(`take_at`, 1, 10)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|   STREAM DATA SINK                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|     EXCHANGE ID: 10                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|     HASH_PARTITIONED: <slot 9> substr(`take_at`, 1, 10)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|   7:AGGREGATE (merge finalize)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|   |  output: sum(<slot 6> sum(if(`is_effect` = 1, `payment`, 0))), multi_distinct_count(<slot 7> multi_distinct_count(DISTINCT if(`is_effect` = 1, `ouid`, NULL))), multi_distinct_count(<slot 8> multi_distinct_count(DISTINCT `ouid`))                                                                                                                                                                                                                                                                                                                                                                               |
|   |  group by: <slot 5> substr(`take_at`, 1, 10)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|   |  cardinality=-1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|   6:EXCHANGE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| PLAN FRAGMENT 5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|  OUTPUT EXPRS:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|   PARTITION: HASH_PARTITIONED: `default_cluster:dwd`.`dwd_order_detail`.`brand_code`, `default_cluster:dwd`.`dwd_order_detail`.`merchant_num`, `default_cluster:dwd`.`dwd_order_detail`.`ouid`                                                                                                                                                                                                                                                                                                                                                                                                                         |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|   STREAM DATA SINK                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|     EXCHANGE ID: 06                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|     HASH_PARTITIONED: <slot 5> substr(`take_at`, 1, 10)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|   1:AGGREGATE (update serialize)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|   |  STREAMING                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|   |  output: sum(if(`is_effect` = 1, `payment`, 0)), multi_distinct_count(DISTINCT if(`is_effect` = 1, `ouid`, NULL)), multi_distinct_count(DISTINCT `ouid`)                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|   |  group by: substr(`take_at`, 1, 10)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|   |  cardinality=-1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|   0:OlapScanNode                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|      TABLE: dwd_order_detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|      PREAGGREGATION: OFF. Reason: aggExpr.getChild(0)[FunctionCallExpr{name=if, isStar=false, isDistinct=false, ((SlotRef{slotDesc=SlotDescriptor{id=1, parent=0, col=is_effect, type=INT, materialized=true, byteSize=0, byteOffset=-1, nullIndicatorByte=0, nullIndicatorBit=0, slotIdx=0}, col=is_effect, label=`is_effect`, tblName=null} ) SlotRef{slotDesc=SlotDescriptor{id=2, parent=0, col=payment, type=DECIMAL(9,0), materialized=true, byteSize=0, byteOffset=-1, nullIndicatorByte=0, nullIndicatorBit=0, slotIdx=0}, col=payment, label=`payment`, tblName=null} )}] is not SlotRef or CastExpr|CaseExpr |
|      PREDICATES: `merchant_num` = 1011484, `take_at` IS NOT NULL, `default_cluster:dwd.dwd_order_detail`.`__DORIS_DELETE_SIGN__` = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|      partitions=148/151                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|      rollup: dwd_order_detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|      tabletRatio=2368/2368                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|      tabletList=8492494,8492498,8492502,8492506,8492510,8492514,8492518,8492522,8492526,8492530 ...                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|      cardinality=333631155                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|      avgRowSize=75.79617                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|      numNodes=10                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
114 rows in set (0.01 sec)

```
分布式查询计划是由多个 Fragment 组成的，每个 Fragment 负责查询计划的一部分，各个 Fragment 之间会通过 ExchangeNode 算子进行数据的传输。
从图中可以看出，查询计划树被分为了5个 Fragment：0、1、2、3、4。两个 Fragment 之间通过一个 ExchangeNode 节点传输数据。
而一个 Fragment 会进一步的划分为多个 Instance。Instance 是最终具体的执行实例。划分成多个 Instance 有助于充分利用机器资源，提升一个 Fragment 的执行并发度。

## 2、查看查询 Profile
用户可以通过以下命令打开会话变量is_report_success：
```shell
SET is_report_success=true;
```
然后执行查询，则 Doris 会产生该查询的一个 Profile。Profile 包含了一个查询各个节点的具体执行情况，有助于我们分析查询瓶颈。
执行完查询后，我们可以通过如下命令先获取 Profile 列表：
```shell
mysql> show query profile "/"\G
*************************** 1. row ***************************
   QueryId: c257c52f93e149ee-ace8ac14e8c9fef9
      User: root
 DefaultDb: default_cluster:db1
       SQL: select tbl1.k1, sum(tbl1.k2) from tbl1 join tbl2 on tbl1.k1 = tbl2.k1 group by tbl1.k1 order by tbl1.k1
 QueryType: Query
 StartTime: 2021-04-08 11:30:50
   EndTime: 2021-04-08 11:30:50
 TotalTime: 9ms
QueryState: EOF
```
这个命令会列出当前保存的所有 Profile。每行对应一个查询。我们可以选择我们想看的 Profile 对应的 QueryId，查看具体情况。
查看一个Profile分为3个步骤：
### 2.1 查看整体执行计划树
这一步主要用于从整体分析执行计划，并查看每个Fragment的执行耗时。
```shell
MySQL [dwd_test]> 
  
*************************** 1. row ***************************
Fragments:                      ┌───────────────────────┐
                     │[-1: DataBufferSender] │
                     │Fragment: 0            │
                     │MaxActiveTime: 14s259ms│
                     └───────────────────────┘
                                 │
                                 │
                       ┌───────────────────┐
                       │[12: EXCHANGE_NODE]│
                       │Fragment: 0        │
                       └───────────────────┘
                                 │
                                 │
                     ┌───────────────────────┐
                     │[12: DataStreamSender] │
                     │Fragment: 1            │
                     │MaxActiveTime: 14s253ms│
                     └───────────────────────┘
                                 │
                                 │
                         ┌──────────────┐
                         │[5: SORT_NODE]│
                         │Fragment: 1   │
                         └──────────────┘
                                 │
                                 │
                       ┌───────────────────┐
                       │[4: HASH_JOIN_NODE]│
                       │Fragment: 1        │
                       └───────────────────┘
                ┌────────────────┴────────────────┐
                │                                 │
      ┌───────────────────┐             ┌───────────────────┐
      │[10: EXCHANGE_NODE]│             │[11: EXCHANGE_NODE]│
      │Fragment: 1        │             │Fragment: 1        │
      └───────────────────┘             └───────────────────┘
                │                                 │
                │                                 │
    ┌───────────────────────┐         ┌──────────────────────┐
    │[10: DataStreamSender] │         │[11: DataStreamSender]│
    │Fragment: 4            │         │Fragment: 2           │
    │MaxActiveTime: 14s240ms│         │MaxActiveTime: 9s570ms│
    └───────────────────────┘         └──────────────────────┘
                │                                 │
                │                                 │
     ┌─────────────────────┐           ┌─────────────────────┐
     │[7: AGGREGATION_NODE]│           │[9: AGGREGATION_NODE]│
     │Fragment: 4          │           │Fragment: 2          │
     └─────────────────────┘           └─────────────────────┘
                │                                 │
                │                                 │
      ┌──────────────────┐              ┌──────────────────┐
      │[6: EXCHANGE_NODE]│              │[8: EXCHANGE_NODE]│
      │Fragment: 4       │              │Fragment: 2       │
      └──────────────────┘              └──────────────────┘
                │                                 │
                │                                 │
    ┌───────────────────────┐         ┌──────────────────────┐
    │[6: DataStreamSender]  │         │[8: DataStreamSender] │
    │Fragment: 5            │         │Fragment: 3           │
    │MaxActiveTime: 11s662ms│         │MaxActiveTime: 9s561ms│
    └───────────────────────┘         └──────────────────────┘
                │                                 │
                │                                 │
     ┌─────────────────────┐           ┌─────────────────────┐
     │[1: AGGREGATION_NODE]│           │[3: AGGREGATION_NODE]│
     │Fragment: 5          │           │Fragment: 3          │
     └─────────────────────┘           └─────────────────────┘
                │                                 │
                │                                 │
      ┌───────────────────┐             ┌───────────────────┐
      │[0: OLAP_SCAN_NODE]│             │[2: OLAP_SCAN_NODE]│
      │Fragment: 5        │             │Fragment: 3        │
      └───────────────────┘             └───────────────────┘
                │                                 │
                │                                 │
┌───────────────────────────────┐ ┌───────────────────────────────┐
│[OlapScanner(dwd_order_detail)]│ │[OlapScanner(dwd_order_detail)]│
│Fragment: 5                    │ │Fragment: 3                    │
└───────────────────────────────┘ └───────────────────────────────┘
                │                                 │
                │                                 │
       ┌─────────────────┐               ┌─────────────────┐
       │[SegmentIterator]│               │[SegmentIterator]│
       │Fragment: 5      │               │Fragment: 3      │
       └─────────────────┘               └─────────────────┘

1 row in set (0.01 sec)
```
如上图，每个节点都标注了自己所属的 Fragment，并且在每个 Fragment 的 Sender节点，标注了该 Fragment 的执行耗时。这个耗时，是Fragment下所有 Instance 执行耗时中最长的一个。这个有助于我们从整体角度发现最耗时的 Fragment。

### 2.2 查看具体 Fragment 下的 Instance 列表
比如我们发现 Fragment 4 耗时最长，则可以继续查看 Fragment 4 的 Instance 列表：
```shell
MySQL [(none)]> show query profile "/40581c8a205c488a-9e66c44e328d4b29/4";
+-----------------------------------+--------------------+------------+
| Instances                         | Host               | ActiveTime |
+-----------------------------------+--------------------+------------+
| 40581c8a205c488a-9e66c44e328d4b3a | 172.16.0.112:9069  | 14s240ms   |
| 40581c8a205c488a-9e66c44e328d4b39 | 172.16.0.114:9069  | 13s884ms   |
| 40581c8a205c488a-9e66c44e328d4b35 | 172.16.0.109:9069  | 13s631ms   |
| 40581c8a205c488a-9e66c44e328d4b37 | 172.16.0.115:9069  | 13s562ms   |
| 40581c8a205c488a-9e66c44e328d4b3d | 172.16.0.116:9069  | 13s429ms   |
| 40581c8a205c488a-9e66c44e328d4b38 | 172.16.0.108:9069  | 13s244ms   |
| 40581c8a205c488a-9e66c44e328d4b3b | 172.16.0.98:9069   | 12s861ms   |
| 40581c8a205c488a-9e66c44e328d4b3c | 172.16.17.218:9069 | 12s828ms   |
| 40581c8a205c488a-9e66c44e328d4b34 | 172.16.0.113:9069  | 12s676ms   |
| 40581c8a205c488a-9e66c44e328d4b36 | 172.16.0.97:9069   | 12s565ms   |
+-----------------------------------+--------------------+------------+
10 rows in set (0.00 sec)

```
由此可以看出instance和Doris be数量一致。

### 2.3 查看具体 Instance
可以继续查看某一个具体的 Instance 上各个算子的详细 Profile：
```shell
MySQL [(none)]> show query profile "/40581c8a205c488a-9e66c44e328d4b29/4/40581c8a205c488a-9e66c44e328d4b3a";
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Instance                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ┌────────────────────────────────────────────────────┐
│[10: DataStreamSender]                              │
│(Active: 255.242us, non-child: 0.00)                │
│  - Counters:                                       │
│      - BytesSent: 16.01 KB                         │
│      - IgnoreRows: 0                               │
│      - LocalBytesSent: 0.00                        │
│      - OverallThroughput: 61.253777503967285 MB/sec│
│      - PeakMemoryUsage: 48.00 KB                   │
│      - SerializeBatchTime: 156.136us               │
│      - UncompressedRowBatchSize: 34.89 KB          │
└────────────────────────────────────────────────────┘
                           │
                           │
        ┌────────────────────────────────────┐
        │[7: AGGREGATION_NODE]               │
        │(Active: 14s239ms, non-child: 35.36)│
        │  - Counters:                       │
        │      - BuildTime: 3s367ms          │
        │      - GetResultsTime: 1s677ms     │
        │      - HTResize: 0                 │
        │      - HTResizeTime: 80.904us      │
        │      - HashBuckets: 16.384K (16384)│
        │      - HashCollisions: 0           │
        │      - HashFailedProbe: 0          │
        │      - HashFilledBuckets: 458      │
        │      - HashProbe: 4.358K (4358)    │
        │      - HashTravelLength: 30        │
        │      - LargestPartitionPercent: 0  │
        │      - MaxPartitionLevel: 0        │
        │      - NumRepartitions: 0          │
        │      - PartitionsCreated: 16       │
        │      - PeakMemoryUsage: 69.02 MB   │
        │      - RowsProcessed: 4.358K (4358)│
        │      - RowsRepartitioned: 0        │
        │      - RowsReturned: 458           │
        │      - RowsReturnedRate: 32        │
        │      - SpilledPartitions: 0        │
        └────────────────────────────────────┘
                           │
                           │
    ┌────────────────────────────────────────────┐
    │[6: EXCHANGE_NODE]                          │
    │(Active: 9s191ms, non-child: 64.39)         │
    │  - Counters:                               │
    │      - BytesReceived: 100.17 MB            │
    │      - ConvertRowBatchTime: 104.863us      │
    │      - DataArrivalWaitTime: 9s184ms        │
    │      - DeserializeRowBatchTimer: 270.842ms │
    │      - FirstBatchArrivalWaitTime: 5s911ms  │
    │      - PeakMemoryUsage: 139.43 MB          │
    │      - RowsReturned: 4.358K (4358)         │
    │      - RowsReturnedRate: 474               │
    │      - SendersBlockedTotalTimer(*): 2s596ms│
    └────────────────────────────────────────────┘
 |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.01 sec)

```
通过以上3个步骤，我们可以逐步排查一个SQL的性能瓶颈。
通过以上分析doris 查询sql瓶颈主要在：
聚合：特别的：count(distinct if(is_effect=1,ouid,null)),2)，95%以上的时间都在聚合。
```shell
[7: AGGREGATION_NODE]               │
       │(Active: 11s375ms, non-child: 48.07)│
       │  - Counters:                       │
       │      - BuildTime: 3s738ms          │
       │      - GetResultsTime: 1s745ms     │
       │      - HTResize: 0                 │
       │      - HTResizeTime: 58.443us      │
       │      - HashBuckets: 16.384K (16384)│
       │      - HashCollisions: 0           │
       │      - HashFailedProbe: 0          │
       │      - HashFilledBuckets: 467      │
       │      - HashProbe: 4.425K (4425)    │
       │      - HashTravelLength: 20        │
       │      - LargestPartitionPercent: 0  │
       │      - MaxPartitionLevel: 0        │
       │      - NumRepartitions: 0          │
       │      - PartitionsCreated: 16       │
       │      - PeakMemoryUsage: 58.04 MB   │
       │      - RowsProcessed: 4.425K (4425)│
       │      - RowsRepartitioned: 0        │
       │      - RowsReturned: 467           │
       │      - RowsReturnedRate: 41        │
       │      - SpilledPartitions: 0    
```
join耗时较少：
```shell
|                   ┌───────────────────────────────────────────────────┐
                  │[12: DataStreamSender]                             │
                  │(Active: 269.701us, non-child: 0.00)               │
                  │  - Counters:                                      │
                  │      - BytesSent: 22.71 KB                        │
                  │      - IgnoreRows: 0                              │
                  │      - LocalBytesSent: 0.00                       │
                  │      - OverallThroughput: 82.24482250213623 MB/sec│
                  │      - PeakMemoryUsage: 2.00 KB                   │
                  │      - SerializeBatchTime: 201.633us              │
                  │      - UncompressedRowBatchSize: 38.17 KB         │
                  └───────────────────────────────────────────────────┘
                                            │
                                            │
                          ┌───────────────────────────────────┐
                          │[5: SORT_NODE]                     │
                          │(Active: 11s389ms, non-child: 0.01)│
                          │  - Counters:                      │
                          │      - PeakMemoryUsage: 124.00 KB │
                          │      - RowsReturned: 467          │
                          │      - RowsReturnedRate: 41       │
                          └───────────────────────────────────┘
                                            └┐
                                             │
                       ┌──────────────────────────────────────────┐
                       │[4: HASH_JOIN_NODE]                       │
                       │(Active: 11s387ms, non-child: 0.00)       │
                       │  - Counters:                             │
                       │      - BuildBuckets: 1.024K (1024)       │
                       │      - BuildRows: 75                     │
                       │      - BuildTime: 4.760ms                │
                       │      - HashTableMaxList: 2               │
                       │      - HashTableMinList: 1               │
                       │      - LoadFactor: 4589801338988134400.00│
                       │      - PeakMemoryUsage: 100.00 KB        │
                       │      - ProbeRows: 467                    │
                       │      - ProbeTime: 30.784us               │
                       │      - PushDownComputeTime: 0ns          │
                       │      - PushDownTime: 0ns                 │
                       │      - RowsReturned: 467                 │
                       │      - RowsReturnedRate: 41              │
                       └──────────────────────────────────────────┘
                      ┌──────────────────────┴──────────────────────┐
                      │                                             │
┌───────────────────────────────────────────┐ ┌──────────────────────────────────────────┐
│[10: EXCHANGE_NODE]                        │ │[11: EXCHANGE_NODE]                       │
│(Active: 11s387ms, non-child: 99.79)       │ │(Active: 1s514ms, non-child: 13.27)       │
│  - Counters:                              │ │  - Counters:                             │
│      - BytesReceived: 16.41 KB            │ │      - BytesReceived: 1.45 KB            │
│      - ConvertRowBatchTime: 8.141us       │ │      - ConvertRowBatchTime: 2.699us      │
│      - DataArrivalWaitTime: 11s386ms      │ │      - DataArrivalWaitTime: 1s514ms      │
│      - DeserializeRowBatchTimer: 60.805us │ │      - DeserializeRowBatchTimer: 10.19us │
│      - FirstBatchArrivalWaitTime: 10s635ms│ │      - FirstBatchArrivalWaitTime: 1s509ms│
│      - PeakMemoryUsage: 34.00 KB          │ │      - PeakMemoryUsage: 4.59 KB          │
│      - RowsReturned: 467                  │ │      - RowsReturned: 75                  │
│      - RowsReturnedRate: 41               │ │      - RowsReturnedRate: 49              │
│      - SendersBlockedTotalTimer(*): 0ns   │ │      - SendersBlockedTotalTimer(*): 0ns  │
└───────────────────────────────────────────┘ └──────────────────────────────────────────┘

```

## 3 参数优化
parallel_fragment_exec_instance_num针对扫描节点，设置其在每个 BE 节点上，执行实例的个数。默认为 1。一个查询计划通常会产生一组 scan range，即需要扫描的数据范围。这些数据分布在多个 BE 节点上。一个 BE 节点会有一个或多个 scan range。默认情况下，每个 BE 节点的一组 scan range 只由一个执行实例处理。当机器资源比较充裕时，可以将增加该变量，让更多的执行实例同时处理一组 scan range，从而提升查询效率。而 scan 实例的数量决定了上层其他执行节点，如聚合节点，join 节点的数量。因此相当于增加了整个查询计划执行的并发度。修改该参数会对大查询效率提升有帮助，但较大数值会消耗更多的机器资源，如 -CPU、内存、磁盘 IO。